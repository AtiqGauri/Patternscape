{"version":3,"sources":["../src/CancellationToken.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from \"events\"\n\nexport class CancellationToken extends EventEmitter {\n  private parentCancelHandler: (() => any) | null = null\n\n  private _cancelled: boolean\n  get cancelled(): boolean {\n    return this._cancelled || (this._parent != null && this._parent.cancelled)\n  }\n\n  private _parent: CancellationToken | null = null\n  set parent(value: CancellationToken) {\n    this.removeParentCancelHandler()\n\n    this._parent = value\n    this.parentCancelHandler = () => this.cancel()\n    this._parent.onCancel(this.parentCancelHandler)\n  }\n\n  // babel cannot compile ... correctly for super calls\n  constructor(parent?: CancellationToken) {\n    super()\n\n    this._cancelled = false\n    if (parent != null) {\n      this.parent = parent\n    }\n  }\n\n  cancel() {\n    this._cancelled = true\n    this.emit(\"cancel\")\n  }\n\n  private onCancel(handler: () => any) {\n    if (this.cancelled) {\n      handler()\n    }\n    else {\n      this.once(\"cancel\", handler)\n    }\n  }\n\n  createPromise<R>(callback: (resolve: (thenableOrResult?: R) => void, reject: (error: Error) => void, onCancel: (callback: () => void) => void) => void): Promise<R> {\n    if (this.cancelled) {\n      return Promise.reject<R>(new CancellationError())\n    }\n\n    const finallyHandler = () => {\n      if (cancelHandler != null) {\n        try {\n          this.removeListener(\"cancel\", cancelHandler)\n          cancelHandler = null\n        }\n        catch (ignore) {\n          // ignore\n        }\n      }\n    }\n\n    let cancelHandler: (() => void) | null = null\n    return new Promise<R>((resolve, reject) => {\n      let addedCancelHandler: (() => void) | null = null\n\n      cancelHandler = () => {\n        try {\n          if (addedCancelHandler != null) {\n            addedCancelHandler()\n            addedCancelHandler = null\n          }\n        }\n        finally {\n          reject(new CancellationError())\n        }\n      }\n\n      if (this.cancelled) {\n        cancelHandler()\n        return\n      }\n\n      this.onCancel(cancelHandler)\n\n      callback(resolve, reject, (callback: () => void) => {\n        addedCancelHandler = callback\n      })\n    })\n      .then(it => {\n        finallyHandler()\n        return it\n      })\n      .catch(e => {\n        finallyHandler()\n        throw e\n      })\n  }\n\n  private removeParentCancelHandler() {\n    const parent = this._parent\n    if (parent != null && this.parentCancelHandler != null) {\n      parent.removeListener(\"cancel\", this.parentCancelHandler)\n      this.parentCancelHandler = null\n    }\n  }\n\n  dispose() {\n    try {\n      this.removeParentCancelHandler()\n    }\n    finally {\n      this.removeAllListeners()\n      this._parent = null\n    }\n  }\n}\n\nexport class CancellationError extends Error {\n  constructor() {\n    super(\"Cancelled\")\n  }\n}"],"sourceRoot":""}
